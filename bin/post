#!/bin/bash

set -e

cd $(dirname $(readlink -f "$0"))/..

bin/package --vignette

cd R
TGZ_NAME=$(ls -1t *.tar.gz | head -1)
R CMD check --as-cran $TGZ_NAME
cp -f $TGZ_NAME ../deliveries/$TGZ_NAME
cd ..

## Prepare webserver
ssh dahl.byu.edu mkdir -p public/rscala

## Post package
REPOS=docs/devel/website-professional/html/rpackages
scp "deliveries/$TGZ_NAME" "dahl:$REPOS/src/contrib"
ssh dahl "$REPOS/mkPseudoBinaries src/contrib/$TGZ_NAME"
ssh dahl "$REPOS/updatePACKAGES"
echo -e "####\nPosted to\n  https://dahl.byu.edu/rpackages/src/contrib/$TGZ_NAME\n####"

## Post Scaladoc 
R --slave -e "rscala:::scalaSBT(c('packageDoc'),FALSE,FALSE)"
rsync -r --chmod=go=rX target/scala-2.13/api/ dahl.byu.edu:public/rscala/doc

## Post vignete
cd deliveries
tar -zxvf $TGZ_NAME rscala/inst/doc/rscala.pdf
rsync --chmod=go=rX rscala/inst/doc/rscala.pdf dahl.byu.edu:public/rscala
rm rscala/inst/doc/rscala.pdf
rmdir rscala/inst/doc
rmdir rscala/inst
rmdir rscala

